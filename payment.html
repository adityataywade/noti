<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Payment - CampusMart</title>
  <link rel="stylesheet" href="style.css?v=1">
  <link rel="stylesheet" href="style2.css" />
  <link rel="icon" href="ekd-logo.png" type="image/png" />
  <link rel="apple-touch-icon" href="ekd-logo.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
</head>

<body>
  <header id="navbar-container">
    <nav class="market-navbar">
      <div class="market-navbar__container">
        <div class="market-navbar__logo" onclick="window.location.href='index.html'">
          <img src="ekd-logo.png" alt="CampusMart Logo" class="market-navbar__logo-img" />
          <span class="market-navbar__brand">CampusMart</span>
        </div>
  <!-- Reserve Payment Popup -->
  <div id="qrPopupReserve" class="qr-popup-modern glass-popup" style="display:none;">
    <div class="qr-content-modern light-glass">
      <span class="close-btn-modern" onclick="closePaymentPopup()">&times;</span>
      <h2 class="popup-heading">Scan & Pay (Reservation)</h2>
      <img src="payment.jpg" alt="QR Code" class="qr-img-modern" />
      <p class="upi-id-modern">UPI ID: <strong>dipaktaywade3@okaxis</strong></p>
      <h3 class="popup-subheading">After Payment, Submit Proof</h3>
      <input type="text" id="popupPaymentIdReserve" placeholder="Enter Your Mobile Number" class="glass-input" />
      <input type="file" id="popupPaymentScreenshotReserve" accept="image/*" class="glass-file" />
      <div class="qrLoadingSpinner" style="display:none; text-align:center; margin:10px 0;">
        <i class="fa fa-spinner fa-spin" style="font-size:1.6em; color:#1a73e8;"></i>
        <div style="color:#1a73e8; font-weight:600;">Uploading...</div>
      </div>
      <button onclick="sendPaymentId()" class="glass-button send-id-btn">
        <i class="fas fa-paper-plane"></i> Submit Payment
      </button>
    </div>
  </div>
        <div class="market-navbar__searchbar" id="marketNavbarSearchbar">
          <select class="market-navbar__select" id="categoryFilter" aria-label="Category">
            <option value="All">All</option>
            <option value="Electronics">Electronics</option>
            <option value="Books">Books</option>
            <option value="Calculators">Calculators</option>
            <option value="Stationery">Stationery</option>
            <option value="Laptops">Laptops</option>
            <option value="Smartphones">Smartphones</option>
            <option value="Gaming">Gaming</option>
            <option value="Beauty">Beauty</option>
            <option value="Pets">Pets</option>
            <option value="Clothing">Clothing</option>
            <option value="Accessories">Accessories</option>
            <option value="Home Essentials">Home Essentials</option>
            <option value="Art & Craft">Art & Craft</option>
            <option value="Furniture">Furniture</option>
            <option value="Sports">Sports</option>
            <option value="Music">Music</option>
            <option value="Kitchen">Kitchen</option>
            <option value="Toys">Toys</option>
            <option value="Other">Other</option>
          </select>
          <div class="market-navbar__search-wrapper">
            <input type="text" class="market-navbar__search" id="searchInput" placeholder="Search products..."
              aria-label="Search products">
          </div>
        </div>
        <ul class="market-navbar__links" id="marketNavbarLinks">
          <li><a href="index.html">Home</a></li>
          <li><a href="#shopSection">Shop</a></li>
          <li><a href="#sell">Sell</a></li>
        </ul>
        <div class="market-navbar__actions">
          <button class="yellow-glass-btn" onclick="window.location.href='cart.html'" title="My Orders">
            <i class="fa-solid fa-cart-shopping"></i> My Orders
          </button>
          <span id="userEmail" class="navbar-user-email" style="display: none;"></span>
          <button id="navbarLoginBtn" class="yellow-glass-btn" style="display: none;">
            <i class="fa fa-sign-in-alt"></i> Login
          </button>
          <button id="logoutBtn" class="yellow-glass-btn" style="display: none;">
            <i class="fa fa-sign-out-alt"></i> Logout
          </button>
          <button id="installBtn" class="market-navbar__btn install-btn">
            <i class="fa-solid fa-download"></i> Install App
          </button>
          <div id="recaptcha-container"></div>
        </div>
        <button class="market-navbar__hamburger" id="marketNavbarHamburger" aria-label="Toggle navigation">
          <span></span><span></span><span></span>
        </button>
      </div>
    </nav>
  </header>

  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="document.getElementById('loginModal').style.display='none'">&times;</span>
      <h2>Login or Register</h2>

      <input type="email" id="authEmail" placeholder="Enter your email">
      <input type="password" id="authPassword" placeholder="Enter your password">

      <button id="googleLoginBtn" class="google-btn"
        style="display:flex;align-items:center;gap:10px;justify-content:center;width:100%;padding:10px 0;margin:18px 0 10px 0;background:#fff;border:1px solid #ccc;border-radius:6px;cursor:pointer;transition:box-shadow 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
        <svg class="google-icon" width="24" height="24" viewBox="0 0 48 48"
          style="width:24px;height:24px;display:inline-block;vertical-align:middle;flex-shrink:0;">
          <g>
            <path fill="#4285F4"
              d="M43.6 20.5h-1.9V20H24v8h11.3c-1.5 4-5.2 7-9.3 7-5.5 0-10-4.5-10-10s4.5-10 10-10c2.4 0 4.6 0.9 6.3 2.3l6.1-6.1C34.5 8.1 29.5 6 24 6 13.5 6 5 14.5 5 25s8.5 19 19 19c10.5 0 19-8.5 19-19 0-1.3-0.1-2.7-0.4-4z" />
            <path fill="#34A853"
              d="M24 44c5.1 0 9.4-1.7 12.5-4.7l-6.1-5.1c-1.7 1.1-3.8 1.8-6.4 1.8-4.1 0-7.8-2.7-9.1-6.4H8.2v5.3C11.3 40.3 17.2 44 24 44z" />
            <path fill="#FBBC05"
              d="M14.9 29.6c-0.4-1.1-0.7-2.3-0.7-3.6s0.3-2.5 0.7-3.6v-5.3H8.2C7.1 19.7 6 22.2 6 25s1.1 5.3 2.2 7.4l6.7-5.8z" />
            <path fill="#EA4335"
              d="M24 14.5c2.6 0 4.9 0.9 6.7 2.7l5-5C32.9 9.1 28.7 7 24 7c-6.8 0-12.7 3.7-15.8 9.3l6.7 5.3c1.3-3.7 5-6.4 9.1-6.4z" />
            <path fill="none" d="M0 0h48v48H0z" />
          </g>
        </svg>
        <span style="font-size:1.05rem;color:#222;font-weight:500;display:inline-block;vertical-align:middle;">Sign in
          with Google</span>
      </button>
      <!-- Buttons -->
      <div class="btn-group">
        <button id="loginBtn">Login</button>
        <button id="registerBtn">Sign Up</button>
      </div>
    </div>
  </div>
  <div id="adminLoginModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="document.getElementById('adminLoginModal').style.display='none'">&times;</span>
      <h2>Admin Login</h2>
      <input type="text" id="adminUsername" placeholder="Username">
      <input type="password" id="adminPassword" placeholder="Password">
      <button id="adminLoginSubmit" class="admin-btn">Login as Admin</button>
    </div>
  </div>
  <div id="mobileTray" class="mobile-tray">
    <button class="tray-close-btn" id="closeTrayBtn">&times;</button>
    <div class="tray-section" id="trayUserId">Your ID: <span id="trayUserEmail">Not logged in</span></div>
    <button id="mobileInstallBtn" class="market-navbar__btn install-btn" style="display: none;">
      <i class="fa-solid fa-download"></i> Install App
    </button>
    <button class="yellow-glass-btn" id="myOrdersBtn" style="display:none;">My Orders</button>
    <button class="tray-btn" id="trayAdminBtn"><i class="fa fa-user-shield"></i> Admin</button>
    <button class="tray-btn" id="trayLoginBtn"><i class="fa fa-sign-in-alt"></i> Login</button>
    <button class="tray-btn" id="trayLogoutBtn" style="display:none;"><i class="fa fa-sign-out-alt"></i> Logout</button>
    <button class="tray-btn" id="trayCartBtn"><i class="fa fa-cart-shopping"></i> My Cart</button>
  </div>
  <!-- <div id="reviewPopup" class="review-popup"> -->
    
  <div class="payment-container">
    <div class="product-details">
      <div id="optionalGallery" class="thumbnail-gallery"></div>
      <div class="product-image" id="productImage"></div>
      <!-- Moved here: Difference box under product image (left column) -->
      <div class="cm-mode-info" style="margin-top:10px;">
        <div class="cm-mode-title">Full vs Reserve</div>
        <div class="cm-mode-cols">
          <div class="cm-mode-col">
            <div class="cm-mode-col-title">Full Payment</div>
            <ul>
              <li>Pay 100% now</li>
              <li>Faster processing</li>
            </ul>
          </div>
          <div class="cm-mode-col">
            <div class="cm-mode-col-title">Reserve (5%)</div>
            <ul>
              <li>Pay 5% now, rest later</li>
              <li>Item held for you</li>
            </ul>
          </div>
        </div>
      </div>


      <div class="product-info">
        <h2 id="productName">Product Name</h2>
        <p id="productDescription">Product description...</p>
        <p><strong>Category:</strong> <span id="productCategory"></span></p>
        <p><strong>Price:</strong> ‚Çπ<span id="productPrice"></span></p>
        <!-- Coupon (left) + Actions (right) -->
        <div class="coupon-actions-grid">
          <!-- Offer & Coupon Code (left) -->
          <div id="offerCouponBox" class="glassy-box" style="margin-top:10px;padding:12px;border-radius:10px;background:#f5fbff;border:1px solid #d6ecff;">
            <div style="font-weight:600;margin-bottom:6px;">Offer & Coupon Code</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <input id="couponInput" type="text" placeholder="Enter coupon (e.g., CAMPUSMART)" class="glass-input" style="flex:1;min-width:200px;">
              <button id="applyCouponBtn" class="glass-button" type="button">Apply</button>
            </div>
            <div id="couponMsg" style="margin-top:6px;font-size:0.95rem;color:#0f5132;display:none;">Coupon applied.</div>
            <div id="couponErr" style="margin-top:6px;font-size:0.95rem;color:#842029;display:none;">Invalid coupon.</div>
            <div id="priceBreakup" style="margin-top:8px;color:#333;font-size:0.95rem;">
              <div><strong>Display Price:</strong> ‚Çπ<span id="displayPriceSpan">0</span></div>
              <div id="discountRow" style="display:none;"><strong>Coupon Discount (2.5%):</strong> ‚àí‚Çπ<span id="discountSpan">0</span></div>
              <div style="font-weight:700;margin-top:2px;">Payable: ‚Çπ<span id="payableSpan">0</span></div>
            </div>
            <div style="margin-top:8px;color:#666;font-size:0.9rem;">Tip: Use <strong>CAMPUSMART</strong> for 2.5% off. Reservation charges 5% of the <em>discounted</em> price.</div>
          </div>

          <!-- Actions Card: mode + buttons + WhatsApp (right) -->
          <div class="actions-card">
            <!-- Choose Payment Mode -->
            <div class="glassy-box cm-mode-select" style="margin-top:0;padding:10px;border-radius:10px;background:#fff8e1;border:1px solid #ffe0a3;">
              <div style="font-weight:600;margin-bottom:6px;">Choose Payment Mode</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button id="fullPayBtn" class="glass-button" type="button" style="background:#10b981;">Pay Full Price</button>
                <button id="reserveBtn" class="glass-button" type="button" style="background:#f59e0b;">Reserve (Pay 5%)</button>
              </div>
              <div id="modeNote" style="margin-top:6px;color:#444;font-size:0.95rem;">Mode: Full Payment</div>
            </div>

            <!-- Primary payment actions -->
            <div class="payment-section" style="display:none">
              <a id="upiPayButton" href="#" class="pay-btn-modern upi-btn">
                <i class="fas fa-wallet"></i> Pay via UPI App
              </a>
              <button class="pay-btn-modern" onclick="showPaymentPopup()">
                <i class="fas fa-wallet"></i> Proceed to Payment
              </button>
            </div>

            <!-- WhatsApp Inquire (compact) -->
            <a id="whatsappInquireBtn" href="#" class="pay-btn-modern whatsapp-btn">
              <i class="fab fa-whatsapp"></i> Inquire on WhatsApp
            </a>
          </div>
        </div>
      </div>
      <div class="upi-alert-mobile">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="upi-alert-text">
          <strong>Wait! üî¥</strong> After UPI payment, you <b>MUST</b> submit the form below.<br>
          <span class="danger-text">No form = No order ‚úÖ</span>
        </div>
      </div>
      <div class="upi-proof-box glassy-box">
        <h3>üí∏ Submit UPI Payment Proof</h3>
        <p class="instructions">
          After completing your payment <strong> Via UPI App </strong>, please enter your <strong>Mobile Number</strong>
          and upload the
          <strong>payment screenshot</strong> as proof.
        </p>
        <input type="text" id="manualPaymentId" placeholder="Enter your mobile number" class="glass-input" />
        <input type="file" id="paymentProofScreenshot" accept="image/*" class="glass-file" />
        <button onclick="submitUPIPayment()" class="glass-button" id="manualSubmitBtn">
          <!-- Upload spinner (manual proof section) -->
          <div id="uploadSpinner" style="display:none; text-align:center; margin-bottom:10px;">
            <i class="fa fa-spinner fa-spin" style="font-size:2em; color:#1a73e8;"></i>
            <div style="color:#1a73e8;">Uploading...</div>
          </div>
          <span class="submit-text"><i class="fas fa-paper-plane"></i> Submit Payment</span>
        </button>
      </div>
    </div>

    <a href="index.html" class="back-btn">‚Üê Back to Home</a>
    <div id="contactNoteBox"
      style="display:none; margin-top: 20px; padding: 15px; background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 5px;">
      <strong>Note:</strong> if any quries please contact on this number <strong>8766880183</strong>.
    </div>
  </div>
  <section class="attention-guide">
    <h2><span class="icon">üî∞</span> Smooth & Safe Buying Process</h2>
    <div class="attention-cards">
      <div class="attention-card">
        <span class="attention-icon">üõí</span>
        <h3>1. Browse & Select</h3>
        <p>Explore CampusMart and choose your product.</p>
      </div>
      <div class="attention-card">
        <span class="attention-icon">üí≥</span>
        <h3>2. Payment</h3>
        <p>Click <strong>Proceed to Payment</strong> or <strong>Pay via UPI</strong> to send money.</p>
      </div>
      <div class="attention-card">
        <span class="attention-icon">üì§</span>
        <h3>3. Submit Proof</h3>
        <p>Upload your <strong>payment screenshot</strong> with mobile number for verification.</p>
      </div>
      <div class="attention-card highlight-card">
        <span class="attention-icon">üìß</span>
        <h3>4. Order Confirmation</h3>
        <p><strong>After submitting payment proof,</strong> you‚Äôll get an official email with your product & order
          details. <strong>This confirms your order is booked.</strong></p>
      </div>

      <div class="attention-card">
        <span class="attention-icon">üöö</span>
        <h3>5. Delivery</h3>
        <p>We coordinate delivery or pickup. Track updates via WhatsApp or email.</p>
      </div>
      <div class="attention-card">
        <span class="attention-icon">üìû</span>
        <h3>6. Doubts or Bargain?</h3>
        <p>Contact us on WhatsApp <strong>before paying</strong> for any doubt or bargain.</p>
      </div>
      <div class="attention-card">
        <span class="attention-icon">‚úÖ</span>
        <h3>7. Confirm & Done</h3>
        <p>After receiving the product, go to your cart and click <strong>"Confirm Received"</strong>.</p>
      </div>
    </div>
  </section>

  <div id="qrPopup" class="qr-popup-modern glass-popup">
    <div class="qr-content-modern light-glass">
      <span class="close-btn-modern" onclick="closePaymentPopup()">&times;</span>
      <h2 class="popup-heading">Scan & Pay</h2>
      <img src="payment.jpg" alt="QR Code" class="qr-img-modern" />
      <p class="upi-id-modern">UPI ID: <strong>dipaktaywade3@okaxis</strong></p>
      <h3 class="popup-subheading">After Payment, Submit Proof</h3>
      <input type="text" id="popupPaymentId" placeholder="Enter Your Mobile Number" class="glass-input" />
      <input type="file" id="popupPaymentScreenshot" accept="image/*" class="glass-file" />
      <div id="qrLoadingSpinner" style="display:none; text-align:center; margin:10px 0;">
        <i class="fa fa-spinner fa-spin" style="font-size:1.6em; color:#1a73e8;"></i>
        <div style="color:#1a73e8; font-weight:600;">Uploading...</div>
      </div>
      <button onclick="sendPaymentId()" class="glass-button send-id-btn">

        <i class="fas fa-paper-plane"></i> Submit Payment
      </button>
    </div>
  </div>
  <div id="successPopup" class="success-popup">
    <div class="checkmark-wrapper">
      <svg class="checkmark" viewBox="0 0 52 52">
        <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
        <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16" />
      </svg>
      <p class="success-message">Payment Successful!</p>
    </div>
  </div>
  <audio id="successSound" src="success.mp3" preload="auto"></audio>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    function handlePaymentSuccess() {
      document.getElementById("qrPopup").style.display = "none";
      document.getElementById("successPopup").style.display = "flex";
      const sound = document.getElementById("successSound");
      if (sound) {
        sound.muted = false;
        sound.volume = 1.0;
        sound.play().catch(err => {
          console.warn("üîá Autoplay blocked.");
        });
      }
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
      });
      setTimeout(() => {
        alert("üéâ Payment Successful!");
        document.getElementById("successPopup").style.display = "none";
      }, 1500);
    }
  </script>
  <script type="module">
    let currentProduct = null;
    let currentSeller = { name: null, mobile: null };

    // Pricing state
    let paymentMode = 'full'; // 'full' | 'reserve'
    let displayPrice = 0;     // stored price (likely includes 2.5% markup)
    let originalPrice = 0;    // derived base price without markup
    let couponApplied = false;
    let payableAmount = 0;    // final amount user should pay

    import emailjs from 'https://esm.sh/@emailjs/browser';
    emailjs.init("wVTxCgXP-mcJn5IP4");
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import {
      getDatabase, ref, push, set, get, child
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    const cloudinaryUpload = async (file) => {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "your_upload_preset");
      const response = await fetch("https://api.cloudinary.com/v1_1/dobzp321s/image/upload", {
        method: "POST",
        body: formData
      });
      const data = await response.json();
      return data.secure_url;
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    let selectedRating = 0;
    function showReviewPopup() {
      document.getElementById("reviewPopup").style.display = "flex";
    }
    window.closeReviewPopup = () => {
      document.getElementById("reviewPopup").style.display = "none";
    };
    window.submitReview = async () => {
      const reviewText = document.getElementById("userReview").value.trim();
      if (!reviewText || selectedRating === 0) {
        return alert("Please write a review and select a rating.");
      }
      const user = auth.currentUser;
      if (!user) return alert("Login required to submit review.");
      const reviewData = {
        uid: user.uid,
        name: user.displayName || "Anonymous",
        email: user.email,
        message: reviewText,
        rating: selectedRating,
        timestamp: new Date().toISOString()
      };
      try {
        await push(ref(db, "reviews"), reviewData);
        alert("‚úÖ Thanks for your feedback!");
        closeReviewPopup();
      } catch (err) {
        console.error("‚ùå Review failed", err);
        alert("Something went wrong. Try again.");
      }
    };
    document.addEventListener("DOMContentLoaded", () => {
      const stars = document.querySelectorAll(".star");
      stars.forEach(star => {
        star.addEventListener("click", () => {
          selectedRating = parseInt(star.getAttribute("data-value"));
          stars.forEach(s => s.classList.remove("selected"));
          for (let i = 0; i < selectedRating; i++) {
            stars[i].classList.add("selected");
          }
        });
      });
    });
    window.showPaymentPopup = () => {
      const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
      if (isMobile) {
        document.getElementById("upiPayButton").click();
        return;
      }
      // Route popup based on mode
      if (paymentMode === 'reserve') {
        document.getElementById("qrPopupReserve").style.display = "flex";
      } else {
        document.getElementById("qrPopup").style.display = "flex";
      }
    };
    window.closePaymentPopup = () => {
      document.getElementById("qrPopup").style.display = "none";
      const r = document.getElementById("qrPopupReserve");
      if (r) r.style.display = "none";
    };
    function sendBuyerEmail(paymentData) {
      emailjs.send("service_e32z7z5", "template_bd14k2m", {
        to_email: paymentData.buyer_email,
        buyer_name: paymentData.buyer_name,
        product_name: paymentData.productName,
        price: paymentData.amount,
        order_date: new Date().toLocaleString(),
        seller_name: currentSeller.name || "CampusMart Seller",
        seller_mobile: currentSeller.mobile || ""
      }).then(
        (response) => console.log("‚úÖ Buyer confirmation sent!", response),
        (error) => console.error("‚ùå Buyer confirmation failed:", error)
      );
    }
    window.submitUPIPayment = async () => {
      const upiId = document.getElementById("manualPaymentId").value.trim();
      const fileInput = document.getElementById("paymentProofScreenshot");
      const file = fileInput.files[0];
      const button = document.getElementById("manualSubmitBtn");
      const originalText = button.innerHTML;
      if (!upiId || !file || !file.type.startsWith("image/")) {
        alert("‚ùå Please enter Your Mobile Number and upload a valid screenshot.");
        return;
      }
      const user = auth.currentUser;
      if (!user) {
        alert("Please login before submitting payment proof.");
        return;
      }
      button.disabled = true;
      button.innerHTML = `<span class="submit-text">Submitting <span class="spinner"></span></span>`;
      try {
        const screenshotUrl = await cloudinaryUpload(file);
        const proofId = 'proof_' + Date.now();
        const proofData = {
          user_email: user.email || "unknown",
          upi_id: upiId,
          screenshot_url: screenshotUrl,
          timestamp: new Date().toISOString()
        };
        await set(ref(db, 'proof_submissions/' + proofId), proofData);
        showProofPopup();
        document.getElementById("manualPaymentId").value = "";
        fileInput.value = "";
      } catch (error) {
        console.error("‚ùå Failed to submit proof:", error);
        alert("‚ùå Submission failed. Try again.");
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    };
    window.sendPaymentId = async function () {
      const spinner = document.querySelector(paymentMode === 'reserve' ? '#qrPopupReserve .qrLoadingSpinner' : '#qrPopup .qrLoadingSpinner');
      const sendButton = document.querySelector(".send-id-btn");
      if (spinner) spinner.style.display = "block"; // Show spinner if present

      // Let the browser render the spinner before heavy work
      setTimeout(async () => {
        const popupId = paymentMode === 'reserve' ? 'popupPaymentIdReserve' : 'popupPaymentId';
        const enteredId = document.getElementById(popupId).value.trim();
        const screenshotInput = paymentMode === 'reserve' ? 'popupPaymentScreenshotReserve' : 'popupPaymentScreenshot';
        const screenshotFile = document.getElementById(screenshotInput).files[0];

        if (!enteredId || !screenshotFile || !screenshotFile.type.startsWith("image/")) {
          if (spinner) spinner.style.display = "none";
          alert("‚ùå Please enter Your Mobile Number and upload a valid payment screenshot.");
          return;
        }

        const user = auth.currentUser;
        if (!user) {
          if (spinner) spinner.style.display = "none";
          alert("You must be logged in to make a payment.");
          return;
        }

        const product = JSON.parse(localStorage.getItem("selectedProduct"));
        if (!product) {
          if (spinner) spinner.style.display = "none";
          alert("‚ùå No product found in localStorage.");
          return;
        }

        const customPayId = 'pay_' + Date.now();
        try {
          sendButton.disabled = true;
          sendButton.textContent = "Uploading Proof...";

          // Upload screenshot
          const downloadURL = await cloudinaryUpload(screenshotFile);

          // Prepare payment data
          const paymentData = {
            userId: user.uid,
            email: user.email || "",
            payId: enteredId,
            name: user.displayName || "anonymous",
            buyer_name: user.displayName || "anonymous",
            buyer_email: user.email || "",
            amount: payableAmount || "",
            productId: product.id || "",
            productName: product.product_name || "",
            proofUrl: downloadURL,
            timestamp: new Date().toISOString(),
            paymentType: paymentMode,
            couponApplied
          };

          // Store payment and cart info
          await set(ref(db, 'payments/' + customPayId), paymentData);

          const cartProduct = {
            product_name: paymentData.productName,
            price: paymentData.amount,
            category: product.category,
            image_url: product.image_url,
            productId: paymentData.productId,
            payId: paymentData.payId,
            buyerConfirmed: false,
            timestamp: paymentData.timestamp,
            buyer_name: paymentData.buyer_name || paymentData.name || "Unknown",
            buyer_email: paymentData.buyer_email || paymentData.email || "-",
            paymentType: paymentMode,
            couponApplied
          };
          await set(ref(db, `carts/${user.uid}/${customPayId}`), cartProduct);

          // Notify admin and buyer
          emailjs.send("service_e32z7z5", "template_1iq1q95", {
            buyer_name: paymentData.buyer_name,
            buyer_email: paymentData.buyer_email,
            productName: paymentData.productName,
            amount: paymentData.amount,
            payId: paymentData.payId,
            proofUrl: paymentData.proofUrl,
            timestamp: paymentData.timestamp,
            paymentType: paymentMode,
            seller_name: currentSeller.name || '',
            seller_mobile: currentSeller.mobile || ''
          }).then(
            (response) => console.log("‚úÖ Admin notified!", response),
            (error) => console.error("‚ùå Admin notification failed:", error)
          );
          sendBuyerEmail(paymentData);

          // If reservation, also store a reservation record for admin follow-up
          if (paymentMode === 'reserve') {
            try {
              await set(ref(db, 'reservations/' + customPayId), {
                ...paymentData,
                originalPrice,
                reserveAmount: paymentData.amount,
                seller_name: currentSeller.name || '',
                seller_mobile: currentSeller.mobile || ''
              });
            } catch (e) { console.warn('Failed to store reservation record', e); }
          }

          // UI feedback
          handlePaymentSuccess();
          document.querySelector(".pay-btn-modern").style.display = "none";
          const paymentSection = document.querySelector(".payment-section");
          const successMessage = document.createElement("p");
          successMessage.textContent = "‚úÖ Payment Successfully Done!";
          successMessage.style.color = "green";
          successMessage.style.fontWeight = "bold";
          paymentSection.appendChild(successMessage);

        } catch (error) {
          console.error("Payment submission error:", error);
          if (spinner) spinner.style.display = "none";
          alert("Error submitting payment. Please try again.");
        }
        if (spinner) spinner.style.display = "none";
      }, 0); // Let browser render spinner before heavy work
    };

    // Enable/disable button based on input
    document.getElementById("popupPaymentId").addEventListener("input", toggleButton);
    document.getElementById("popupPaymentScreenshot").addEventListener("change", toggleButton);
    function toggleButton() {
      const id = document.getElementById("popupPaymentId").value.trim();
      const file = document.getElementById("popupPaymentScreenshot").files[0];
      document.querySelector(".send-id-btn").disabled = !(id && file);
    }
    window.onload = async () => {
      const product = JSON.parse(localStorage.getItem('selectedProduct'));
      currentProduct = product;
      if (product) {
        document.getElementById('productName').textContent = product.product_name;
        document.getElementById('productDescription').textContent = product.description;
        document.getElementById('productCategory').textContent = product.category;
        document.getElementById('productPrice').textContent = product.price;
        document.getElementById('productImage').style.backgroundImage = `url(${product.image_url})`;

        // Initialize pricing state for coupon & modes
        displayPrice = parseFloat(product.price || '0');
        originalPrice = +(displayPrice / 1.025).toFixed(2);
        payableAmount = displayPrice; // default full payment without coupon
        const displayPriceSpanEl = document.getElementById('displayPriceSpan');
        const payableSpanEl = document.getElementById('payableSpan');
        if (displayPriceSpanEl) displayPriceSpanEl.textContent = displayPrice.toFixed(2);
        if (payableSpanEl) payableSpanEl.textContent = payableAmount.toFixed(2);

        // Inject base price note under product price
        const priceP = document.getElementById('productPrice');
        if (priceP) {
          const note = document.createElement('div');
          note.style.fontSize = '0.9rem';
          note.style.color = '#555';
          note.textContent = `Base: ‚Çπ${originalPrice.toFixed(2)} ‚Ä¢ incl. 2.5% fee`;
          priceP.parentElement && priceP.parentElement.appendChild(note);
        }

        // --- Optional Images Gallery ---
        const dbRef = ref(getDatabase());
        const galleryDiv = document.getElementById('optionalGallery');
        galleryDiv.innerHTML = ""; // Clear previous

        // Always show main image as first thumbnail
        const mainThumb = document.createElement('img');
        mainThumb.src = product.image_url;
        mainThumb.className = 'thumbnail-img selected';
        mainThumb.alt = "Main Image";
        mainThumb.onclick = () => {
          document.getElementById('productImage').style.backgroundImage = `url(${product.image_url})`;
          document.querySelectorAll('.thumbnail-img').forEach(t => t.classList.remove('selected'));
          mainThumb.classList.add('selected');
        };
        galleryDiv.appendChild(mainThumb);

        // Fetch optional images from Firebase
        get(child(dbRef, `products/${product.id}/optionalImgs`)).then(snapshot => {
          if (snapshot.exists()) {
            const imgData = Object.values(snapshot.val());
            imgData.forEach((imgObj, i) => {
              const thumb = document.createElement('img');
              thumb.src = imgObj.url;
              thumb.className = 'thumbnail-img';
              thumb.alt = `Optional Image ${i + 1}`;
              thumb.onclick = () => {
                document.getElementById('productImage').style.backgroundImage = `url(${imgObj.url})`;
                document.querySelectorAll('.thumbnail-img').forEach(t => t.classList.remove('selected'));
                thumb.classList.add('selected');
              };
              galleryDiv.appendChild(thumb);
            });
          }
        });

        // Fetch seller details for emails/reservations
        try {
          const sellersSnap = await get(child(dbRef, 'sellers'));
          if (sellersSnap.exists()) {
            const sellersObj = sellersSnap.val();
            const match = Object.values(sellersObj).find(s => s.product_key === product.id);
            if (match) {
              currentSeller.name = match.seller_name || null;
              currentSeller.mobile = match.seller_mobile || null;
            }
          }
        } catch (e) { console.warn('Failed to fetch seller details', e); }

      } else {
        document.querySelector('.payment-container').innerHTML = '<p style="text-align:center">No product selected.</p>';
        currentProduct = null;
      }
      // Refresh WhatsApp link with product info once loaded
      setWhatsappLink();
    };

    // Coupon & Mode elements
    const couponInput = document.getElementById('couponInput');
    const applyCouponBtn = document.getElementById('applyCouponBtn');
    const couponMsg = document.getElementById('couponMsg');
    const couponErr = document.getElementById('couponErr');
    const discountRow = document.getElementById('discountRow');
    const discountSpan = document.getElementById('discountSpan');
    const payableSpan = document.getElementById('payableSpan');
    const modeNote = document.getElementById('modeNote');
    const fullPayBtn = document.getElementById('fullPayBtn');
    const reserveBtn = document.getElementById('reserveBtn');
    const upiButton = document.getElementById('upiPayButton');
    const paymentSection = document.querySelector('.payment-section');
    const whatsappInquireBtn = document.getElementById('whatsappInquireBtn');

      function refreshAmounts() {
        // Apply coupon to display price if present
        const discount = couponApplied ? +(displayPrice * 0.025).toFixed(2) : 0;
        const discountedPrice = +(displayPrice - discount).toFixed(2);
        if (paymentMode === 'reserve') {
          const reserveAmt = +(discountedPrice * 0.05).toFixed(2);
          payableAmount = reserveAmt;
          if (discountSpan) discountSpan.textContent = discount.toFixed(2);
          if (discountRow) discountRow.style.display = couponApplied ? 'block' : 'none';
          if (modeNote) modeNote.textContent = `Mode: Reservation (Pay 5% of discounted = ‚Çπ${reserveAmt.toFixed(2)})`;
        } else {
          payableAmount = discountedPrice;
          if (discountSpan) discountSpan.textContent = discount.toFixed(2);
          if (discountRow) discountRow.style.display = couponApplied ? 'block' : 'none';
          if (modeNote) modeNote.textContent = 'Mode: Full Payment';
        }
        if (payableSpan) payableSpan.textContent = payableAmount.toFixed(2);
      }

      function showPaymentActions() {
        if (paymentSection) paymentSection.style.display = 'block';
        // Optionally show amount on button label
        if (upiButton) {
          const baseText = 'Pay via UPI App';
          upiButton.querySelector('i')?.classList.add('fa-wallet');
          upiButton.innerHTML = `<i class="fas fa-wallet"></i> ${baseText} (‚Çπ${payableAmount.toFixed(2)})`;
        }
      }

      function buildUpiLink(amount) {
        const pa = 'dipaktaywade3@okaxis'; // payee UPI ID
        const pn = 'CampusMart';
        const tn = `${paymentMode === 'reserve' ? 'Reservation 5%' : 'Full Payment'} - ${currentProduct?.product_name || 'Product'}`;
        const params = new URLSearchParams({ pa, pn, am: amount.toFixed(2), cu: 'INR', tn });
        return `upi://pay?${params.toString()}`;
      }

      function setWhatsappLink() {
        if (!whatsappInquireBtn) return;
        const num = '918766880183';
        const name = encodeURIComponent(currentProduct?.product_name || 'Product');
        const price = encodeURIComponent(`‚Çπ${(currentProduct?.price || payableAmount || 0)}`);
        const msg = encodeURIComponent(`Hi CampusMart, I have a question about "${currentProduct?.product_name || ''}" priced at ${price}.`);
        whatsappInquireBtn.href = `https://wa.me/${num}?text=${msg}`;
      }

      applyCouponBtn && applyCouponBtn.addEventListener('click', () => {
        const val = (couponInput?.value || '').trim().toUpperCase();
        if (val === 'CAMPUSMART') {
          couponApplied = true;
          if (couponMsg) couponMsg.style.display = 'block';
          if (couponErr) couponErr.style.display = 'none';
        } else {
          couponApplied = false;
          if (couponMsg) couponMsg.style.display = 'none';
          if (couponErr) couponErr.style.display = 'block';
        }
        refreshAmounts();
      });

      // Initialize active state (default full)
      if (fullPayBtn && reserveBtn) {
        fullPayBtn.classList.add('active');
        reserveBtn.classList.remove('active');
      }

      // Mode selection handlers -> reveal actions and refresh amounts
      if (fullPayBtn) fullPayBtn.addEventListener('click', () => {
        paymentMode = 'full';
        if (fullPayBtn && reserveBtn) {
          fullPayBtn.classList.add('active');
          reserveBtn.classList.remove('active');
        }
        refreshAmounts();
        showPaymentActions();
      });
      if (reserveBtn) reserveBtn.addEventListener('click', () => {
        paymentMode = 'reserve';
        if (fullPayBtn && reserveBtn) {
          reserveBtn.classList.add('active');
          fullPayBtn.classList.remove('active');
        }
        refreshAmounts();
        showPaymentActions();
      });

      // UPI deep link
      if (upiButton) upiButton.addEventListener('click', (e) => {
        e.preventDefault();
        refreshAmounts(); // ensure latest amount
        const link = buildUpiLink(payableAmount);
        window.location.href = link;
      });

      // Init WhatsApp link once product is loaded
      setWhatsappLink();
    let currentUser = null;
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
    });
  </script>

  <script>
    fetch('footer.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('footer-container').innerHTML = html;
        const links = {
          faqLink: "faqSection",
          returnsLink: "returnsSection",
          shippingLink: "shippingSection",
          contactLink: "contactSection"
        };
        Object.entries(links).forEach(([linkId, sectionId]) => {
          const link = document.getElementById(linkId);
          const section = document.getElementById(sectionId);
          if (link && section) {
            link.addEventListener("click", (e) => {
              e.preventDefault();
              document.querySelectorAll(".footer-info-section").forEach(sec => {
                sec.style.display = "none";
              });
              section.style.display = "block";
              section.scrollIntoView({ behavior: "smooth" });
            });
          }
        });
      });
  </script>
  <div id="footer-container"></div>
  <div id="proofSuccessPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
background: white; border-radius: 10px; padding: 25px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;">
    <h3 style="color: green; margin-bottom: 10px;">‚úÖ Proof Submitted!</h3>
    <p style="font-size: 16px;">Your UPI payment proof has been submitted successfully.</p>
    <button onclick="closeProofPopup()"
      style="margin-top: 15px; background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 5px;">OK</button>
  </div>
  <script src="index.js" type="module" defer></script>
</body>

</html>
